{% if app.user and app.user.userType == 1 %}
<div id="author-edit-modal" class="fixed inset-0 w-full h-full bg-black bg-opacity-50 flex justify-center items-center z-[1000] hidden">
    <div class="bg-white p-5 rounded-lg w-[90%] max-w-[500px] shadow-lg relative">
        <span class="absolute top-2 right-2 text-2xl cursor-pointer" onclick="closeAuthorEditModal()">&times;</span>
        <h2 class="text-xl text-gray-700 font-bold mb-4">Modifier un auteur</h2>
        {{ form_start(form, {'attr': {'id': 'author-edit-form', 'class': 'space-y-4'}, 'action': path('app_author_edit', {'id': 1})}) }}
            {{ form_label(form.name) }}
            {{ form_widget(form.name) }}

            {{ form_row(form.birthYear) }}
            {{ form_row(form.deathYear) }}
            {{ form_row(form.nationality) }}
            {{ form_row(form.link) }}
            {{ form_row(form.image) }}

            <div class="mb-4">
                {{ form_label(form.tags) }}
                {{ form_widget(form.tags, {'attr': {'class': 'w-full p-2 border border-gray-300 rounded', 'multiple': false}}) }}
                <div id="selected-tags-edit" class="mt-2 flex flex-wrap gap-2"></div>
                {{ form_errors(form.tags) }}
            </div>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Enregistrer</button>
        {{ form_end(form) }}
    </div>
</div>

<script>
    function setupTagSelectEdit() {
        const form = document.getElementById('author-edit-form');
        if (!form) return;
        const select = form.querySelector('select');
        const tagDisplay = document.getElementById('selected-tags-edit');
        if (!select || !tagDisplay) return;

        // Nettoyage : retire les anciens eventListeners en remplaçant le select par un clone
        const newSelect = select.cloneNode(true);
        select.parentNode.replaceChild(newSelect, select);

        // On retire l'attribut multiple pour forcer le menu déroulant classique
        newSelect.removeAttribute('multiple');

        // Ajout d'un placeholder si non déjà présent
        if (!newSelect.querySelector('option[disabled][value=""]')) {
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.disabled = true;
            placeholder.selected = true;
            placeholder.hidden = true;
            placeholder.textContent = '-- Choisir des mots-clés --';
            newSelect.insertBefore(placeholder, newSelect.firstChild);
        }

        const inputName = newSelect.name.replace(/\[\]$/, '');

        // Force le placeholder à être sélectionné et les autres à ne pas l'être
        Array.from(newSelect.options).forEach(opt => {
            if (opt.disabled && opt.value === '') {
                opt.selected = true;
            } else {
                opt.selected = false;
            }
        });

        newSelect.addEventListener('change', (e) => {
            const selectedOption = newSelect.selectedOptions[0];
            const tagName = selectedOption.textContent.trim();
            const tagId = selectedOption.value;

            if (!tagId || tagDisplay.querySelector(`input[value="${tagId}"]`)) return;

            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = `${inputName}[]`;
            hidden.value = tagId;

            const tag = document.createElement('span');
            tag.className = 'bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full flex items-center gap-1';
            tag.innerHTML = `
                ${tagName}
                <button type="button" class="remove-tag text-indigo-600 font-bold hover:text-red-500" data-tag-id="${tagId}">&times;</button>
            `;

            tag.appendChild(hidden);
            tagDisplay.appendChild(tag);

            tag.querySelector('.remove-tag').addEventListener('click', () => {
                tag.remove();
            });

            // Réaffiche le placeholder après ajout
            Array.from(newSelect.options).forEach(opt => {
                if (opt.disabled && opt.value === '') {
                    opt.selected = true;
                } else {
                    opt.selected = false;
                }
            });
        });

        // Nettoyer les tags cachés avant soumission pour éviter les doublons
        form.addEventListener('submit', function() {
            Array.from(newSelect.options).forEach(opt => {
                if (!opt.disabled) opt.selected = false;
            });
        });

        // Stocker la référence pour la réutiliser dans openAuthorEditModal
        form._tagSelect = newSelect;
    }

    function openAuthorEditModal(id) {
        const form = document.getElementById('author-edit-form');
        const tagDisplay = document.getElementById('selected-tags-edit');
        const editUrl = `{{ path('app_author_edit', {'id': 'PLACEHOLDER'}) }}`.replace('PLACEHOLDER', id);
        form.action = editUrl;

        fetch(`/library/author/data/${id}`)
            .then(response => response.json())
            .then(data => {
                form.querySelector('[name$="[name]"]').value = data.name;
                form.querySelector('[name$="[birthYear]"]').value = data.birthYear;
                form.querySelector('[name$="[deathYear]"]').value = data.deathYear;
                form.querySelector('[name$="[nationality]"]').value = data.nationality;
                form.querySelector('[name$="[link]"]').value = data.link;
                form.querySelector('[name$="[image]"]').value = data.image;

                // Reset tags display
                tagDisplay.innerHTML = '';

                // Remove all previous hidden inputs for tags
                Array.from(form.querySelectorAll('input[type="hidden"][name^="author[tags]"]')).forEach(e => e.remove());

                // Réinitialise le select sur le placeholder et réapplique la personnalisation
                setupTagSelectEdit();

                // Add tags as badges with hidden inputs
                if (data.tags) {
                    data.tags.forEach(tag => {
                        const hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.name = 'author[tags][]';
                        hidden.value = tag.id;

                        const tagSpan = document.createElement('span');
                        tagSpan.className = 'bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full flex items-center gap-1';
                        tagSpan.innerHTML = `
                            ${tag.name}
                            <button type="button" class="remove-tag text-indigo-600 font-bold hover:text-red-500" data-tag-id="${tag.id}">&times;</button>
                        `;
                        tagSpan.appendChild(hidden);
                        tagDisplay.appendChild(tagSpan);

                        tagSpan.querySelector('.remove-tag').addEventListener('click', () => {
                            tagSpan.remove();
                        });
                    });
                }

                document.getElementById('author-edit-modal').classList.remove('hidden');
            });
    }

    function closeAuthorEditModal() {
        document.getElementById('author-edit-modal').classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', function() {
        setupTagSelectEdit();
    });
</script>
{% endif %}